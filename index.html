<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estimate Rates</title>

  <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
  <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <py-config>
    packages = ["pandas"]
  </py-config>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f9;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 30px;
    }

    .card {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      max-width: 500px;
      width: 100%;
    }

    h2 {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    label {
      font-weight: bold;
      margin-top: 1rem;
      display: block;
    }

    input {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 0.75rem;
      width: 100%;
      border-radius: 0.5rem;
      margin-top: 1.5rem;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }

    .output {
      text-align: center;
      margin-top: 1.5rem;
      font-size: 1.2rem;
    }

    .output span {
      font-weight: bold;
    }

    #map {
      height: 600px;
      margin-top: 40px;
      width: 90%;
      max-width: 900px;
      border: 2px solid #ccc;
      border-radius: 12px;
    }
  </style>
</head>
<body>

  <div class="card">
    <h2>Estimate Rate Calculator</h2>

    <label for="loading">Loading City</label>
    <input id="loading" type="text" placeholder="e.g., Amarillo, TX, USA" />

    <label for="delivery">Delivery City</label>
    <input id="delivery" type="text" placeholder="e.g., McAllen, TX, USA" />

    <button id="calculate">Calculate Estimate</button>

    <div class="output">
      <p>Estimated Rate: <span id="rate">—</span> <span id="currency">—</span></p>
      <p>Miles: <span id="miles">—</span></p>
      <p>$ Per Mile: <span id="ppm">—</span></p>
      <small>**The estimated rates above do not include exportation or inspection fees.</small>
    </div>
  </div>

  <div id="map"></div>

  <!-- Leaflet Map Setup and drawRouteFromGeoJSON -->
  <script>
    let map = L.map('map').setView([39, -98], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let routeLine = null;

    function drawRouteFromGeoJSON(geometry) {
      if (!geometry || !geometry.coordinates) {
        console.error("❌ Invalid geometry:", geometry);
        return;
      }

      const coords = geometry.coordinates[0].map(([lon, lat]) => [lat, lon]);

      if (routeLine) {
        map.removeLayer(routeLine);
      }

      routeLine = L.polyline(coords, {
        color: 'green',
        weight: 5
      }).addTo(map);

      map.fitBounds(routeLine.getBounds());
      console.log("✅ Route drawn on map.");
    }

    window.drawRouteFromGeoJSON = drawRouteFromGeoJSON;
  </script>

  <!-- PyScript Frontend -->
  <py-script>
    from js import document, console, drawRouteFromGeoJSON
    from pyodide.http import pyfetch
    from pyodide.ffi import create_proxy
    import json

    API_URL = "https://estimateratesapi.onrender.com/proxy/estimate"
    API_KEY = "clavePublica123"

    async def calculate_estimate(event):
        try:
            event.preventDefault()

            loading_city = document.getElementById("loading").value
            delivery_city = document.getElementById("delivery").value

            data = {
                "loading_city": loading_city,
                "delivery_city": delivery_city,
            }

            response = await pyfetch(
                url=API_URL,
                method="POST",
                headers={
                    "Content-Type": "application/json",
                    "X-API-Key": API_KEY
                },
                body=json.dumps(data)
            )

            result = await response.json()

            document.getElementById("rate").innerText = str(result.get("estimate", "N/A"))
            document.getElementById("currency").innerText = result.get("currency", "N/A")
            document.getElementById("miles").innerText = str(result.get("miles", "N/A"))
            document.getElementById("ppm").innerText = str(result.get("ppm", "N/A"))

            if "route" in result and result["route"]:
                route_data = result["route"]
                if "geometry" in route_data:
                    drawRouteFromGeoJSON(route_data["geometry"])
                else:
                    console.log("❌ No geometry in route.")
            else:
                console.log("❌ Route data missing.")

        except Exception as e:
            document.getElementById("rate").innerText = "Error"
            console.log(f"❌ Error calculating estimate: {e}")

    calculate_button = document.getElementById("calculate")
    calculate_button.addEventListener("click", create_proxy(calculate_estimate))
  </py-script>

  <footer style="margin-top: 40px; text-align: center; color: #666;">
    © 2025 Gabriela Granda. All rights reserved.
  </footer>

</body>
</html>
